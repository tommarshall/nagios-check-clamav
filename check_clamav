#!/usr/bin/env bash

#
# check_clamav - Nagios plugin for monitoring ClamAV.
#
# Released under the MIT License.
#
# https://github.com/tommarshall/nagios-check-clamav
#

VERSION=0.1.0
OK=0
WARNING=1
CRITICAL=2
UNKNOWN=3
CRITICAL_THRESHOLD=1
WARNING_THRESHOLD=1

#
# Output version.
#

version() {
  echo "check_clamav $VERSION"
}

#
# Output usage information.
#

usage() {
  echo 'Usage: ./check_clamav -l <path> [options]'
}

#
# Output help information.
#

help() {
  usage
  cat <<-EOF

  Examples:
    ./check_clamav -l /tmp/clamav.log

    ./check_clamav -l /tmp/clamav.log -c 10

    ./check_clamav -l /tmp/clamav.log -c 10 -w 5

  Options:
    -l, --logfile <path>        Path to clamscan logfile
    -w, --warning <number>      number of infected files treat as WARNING
    -c, --critical <number>     number of infected files to treat as CRITICAL
    -V, --version               output version
    -h, --help                  output help information

  -c/--critical takes priority over -w/--warning.

  For more information, see https://github.com/tommarshall/nagios-check-clamav

EOF
}

#
# Parse argv.
#

while test $# -ne 0; do
  ARG=$1; shift
  case $ARG in
    -l|--logfile) LOGFILE_PATH=$1; shift ;;
    -w|--warning) WARNING_THRESHOLD=$1; shift ;;
    -c|--critical) CRITICAL_THRESHOLD=$1; shift ;;
    -V|--version) version; exit ;;
    -h|--help) help; exit ;;
    *)
      echo "UNKNOWN: Unrecognised argument: $ARG"
      usage >&2
      exit $UNKNOWN
      ;;
  esac
done

#
# Showtime.
#

# ensure we have a LOGFILE_PATH
if [ -z "$LOGFILE_PATH" ]; then
  echo 'UNKNOWN: --logfile/-l not set'
  exit $UNKNOWN
fi

# ensure we're able to read the LOGFILE_PATH
if ! [[ -f "$LOGFILE_PATH" && -r "$LOGFILE_PATH" ]]; then
  echo "UNKNOWN: Unable to read logfile: ${LOGFILE_PATH}"
  exit $UNKNOWN
fi

# ensure we're able to locate a scan summary within the logfile
SCAN_SUMMARY=$(sed -n -e '/----------- SCAN SUMMARY -----------/,$p' $LOGFILE_PATH)
if [ -z "$SCAN_SUMMARY" ]; then
  echo 'UNKNOWN: Unable to locate scan summary within logfile'
  exit $UNKNOWN
fi

# ensure we're able to locate an infected files count within the scan summary
INFECTED_FILES_COUNT=$(echo "$SCAN_SUMMARY" | grep '^Infected files:' | rev | cut -d' ' -f1 | rev)
if [ -z "$INFECTED_FILES_COUNT" ]; then
  echo 'UNKNOWN: Unable to locate infected files count within scan summary'
  exit $UNKNOWN
fi

#
# report and exit
#

if [ "$INFECTED_FILES_COUNT" -lt "$CRITICAL_THRESHOLD" ]; then
  if [ "$INFECTED_FILES_COUNT" -lt "$WARNING_THRESHOLD" ]; then
    echo "OK: ${INFECTED_FILES_COUNT} infected file(s) detected"
    exit $OK
  fi
  echo "WARNING: ${INFECTED_FILES_COUNT} infected file(s) detected"
  exit $WARNING
fi

echo "CRITICAL: ${INFECTED_FILES_COUNT} infected file(s) detected"
exit $CRITICAL
